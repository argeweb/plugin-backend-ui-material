function json(c,d,a,b){$.ajax({url:c,type:"POST",dataType:"json",cache:false,data:d,async:!1,success:function(e){a(e)},error:function(e,g,f){void 0==b?show_message(e.responseJSON.error):b(e.responseJSON)}})}function json_async(c,d,a,b){$.ajax({url:c,type:"POST",dataType:"json",cache:false,data:d,async:1,success:function(e){a(e)},error:function(e,g,f){void 0==b?show_message(e.responseJSON.error):b(e.responseJSON)}})}function ajax_post(c,d,a,b){$.ajax({url:c,type:"POST",cache:true,data:d,async:true,success:function(e){a(e)},error:function(g,e,f){if(b){b(g.responseText)}else{window.alert(f.message)}}})}function getRandID(d){if(d==undefined){d="rand-id-"}var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var e=0;e<5;e++){d+=c.charAt(Math.floor(Math.random()*c.length))}return d}var save_with_exit=false;var is_saving=false;var timeout_lock_saving=null;var backend=parent;var backToList=backend.iframe.backToList;function showBackToListButton(){$(".backToList").show()}function show_message(b,a){backend.message.quick_show(b,a)}var start_filepicker=backend.uploader.pickup;function parent_is_ready(){show_message=backend.message.quick_show;start_filepicker=backend.uploader.pickup}if(backend.js_is_ready&&backend.js_is_ready==true){show_message=backend.message.quick_show;start_filepicker=backend.uploader.pickup}var pageDOD={visual_timer:3,init:function(){if($(".file_picker_div, .imgs_selector_div, .field-type-rich-text-field").length==0){$("#dropping").addClass("no_target")}},onDragStart:function(a){a.preventDefault();a.stopPropagation();$("html").addClass("dropping");$(".file_picker_div, .imgs_selector_div").parent().parent().addClass("dropping-box")},onDragEnd:function(a){a.preventDefault();a.stopPropagation();pageDOD.visual_timer=0;setTimeout(pageDOD.removeVisualClass,1000)},onDragOver:function(a){a.preventDefault();a.stopPropagation();pageDOD.visual_timer=3;$("html").addClass("dropping");$(".file_picker_div, .imgs_selector_div").parent().parent().addClass("dropping-box")},removeVisualClass:function(){if(pageDOD.visual_timer==0){$("html").removeClass("dropping");$(".file_picker_div, .imgs_selector_div").parent().parent().removeClass("dropping-box");pageDOD.visual_timer=0}else{pageDOD.visual_timer--;setTimeout(pageDOD.removeVisualClass,1000)}},onDrop:function(a){var e=a.dataTransfer.files;a.preventDefault();pageDOD.visual_timer=0;$("html").removeClass("dropping");$(".file_picker_div, .imgs_selector_div").parent().parent().removeClass("dropping-box");;if(e.length>10){backend.message.insert("danger","錯誤","一次可上傳 10個文件",undefined);return}for(var c=0;c<e.length;c++){var b=a.target;var d=getRandID("upload-");if($(b).hasClass("form-group")){$(b).attr("data-uploadId",d)}else{$(b).parents(".form-group").attr("data-uploadId",d)}if($(b).hasClass("mce-content-body")||$(b).parents("body").hasClass("mce-content-body ")){d=$(b).parents("body").data("id")||$(b).data("id");backend.uploader.addFile(e[c],d,pageDOD.setEditorValue)}else{backend.uploader.addFile(e[c],d,pageDOD.setTargetValue)}}},setTargetValue:function(d){var a=d.response.url;var c=d.target_id;var b=$("*[data-uploadId='"+d.target_id+"']");b.find("input").first().val(d.response.url).show();if(a==""){b.find(".file_picker_item").css("background-image","none").addClass("file_picker_item_none")}else{b.find(".file_picker_item").css("background-image","url("+a+")").removeClass("file_picker_item_none")}},setEditorValue:function(c){var a=c.response.url;var b=c.target_id;if(tinyMCE.get(b)){tinyMCE.get(b).selection.setContent('<img src="'+a+'" />')}}};function change_lang(a){$("a.btn-lang").eq(a).click()}function create_editor(b){var a=tinyMCE.createEditor(b,{theme:"modern",content_css:["/plugins/backend_ui_fuscata/static/TinyMCE/4.2.5/skins/lightgray/content.min.css"],height:400,plugins:["link image media code table preview hr anchor pagebreak textcolor fullscreen colorpicker "],toolbar:"undo redo | styleselect | alignleft aligncenter alignright forecolor backcolor bold italic | link upload_image image media | code custom_fullscreen",statusbar:false,menubar:false,setup:function(c){if(typeof filepicker!="undefined"){c.addButton("upload_image",{title:"插入圖片",image:"/plugins/backend_ui_fuscata/static/TinyMCE/4.2.5/themes/upload_image.png",onclick:function(){var d=c;start_filepicker(d,true)}})}c.addButton("custom_fullscreen",{title:"擴大編輯區",image:"/plugins/backend_ui_fuscata/static/TinyMCE/4.2.5/themes/fullscreen.png",onclick:function(){c.execCommand("mceFullScreen")}});c.on("init",function(d){})},convert_urls:false,relative_urls:false,remove_script_host:false});a.render()}function save_form(){if($("form").length<=0){return false}if(is_saving==true){return false}console.log(is_saving);is_saving=true;clearTimeout(timeout_lock_saving);timeout_lock_saving=setTimeout(function(){is_saving=false},5000);var a=$("form");a.find(".field-type-rich-text-field").each(function(){var b=$(this).attr("id");if(tinyMCE.get(b)){$(this).val(tinyMCE.get(b).getContent())}$(this).change()});a.submit()}function save_and_exit(){save_with_exit=true;save_form()}function scrollDiv(){$(".scrollDiv").addClass("on");backend.iframe.removeMask()}$(function(){var a=-70;var b=0;var d=0;if(window.name=="aside_iframe"){a=0;b=56;d=60;$("body").addClass("aside")}$(".aside-header").stop().animate({top:a},300);if($("header").text().trim()!=""){d+=60;$("body").addClass("has-header");$("header").stop().animate({top:b},300);if(a>=0){backend.affix(100)}}else{$("body").addClass("no-header")}$(".aside-close").click(function(){backend.aside.closeUi()});$(".scrollDiv").stop().animate({"margin-top":d},300).hover(function(){scrollDiv()},function(){$(this).removeClass("on")}).mouseover(function(){scrollDiv()}).mouseleave(function(){$(this).removeClass("on")});if(window==top){return}$("#onLoad").remove();$("body").removeClass("body-hide");$(document).on("click",function(f){backend.close_msg_nav()}).on("click",".record_item, .record_item",function(){var e=$(this).parent().data("view-url");if($(this).hasClass("record_item")){e=$(this).data("view-url")}if(e&&e!=""){backend.aside.load(e)}}).on("keydown",function(f){backend.short_key(window.name,f)});pageDOD.init();linkClickProcess();checkNavItemAndShow();$(".enter-sorting-mode").click(function(){$("body").toggleClass("in-sort-mode","")});$("#list-table").on("post-body.bs.table",function(){makeSortTable();makeListOp();checkNavItemAndShow();$(".sortable-list").removeClass("hidden")});try{$("iframe[name='iframeForm']").load(function(){var e=JSON.parse($(this).contents().find("body").text());$(".form-group").removeClass("has-error has-danger").find(".help-block").text("");var g=e.errors;if(g){for(var f in g){$("form #"+f).parents(".form-group").addClass("has-error has-danger").find(".help-block").text(g[f])}if($("form").attr("action").indexOf("/_ah/upload/")>=0){$("form").attr("action",e.new_form_action)}}var h={add:"記錄已新增",edit:"記錄已儲存",profile:"資料已更新","undefined":"未定義的訊息"};if(e.response_info=="success"){if(save_with_exit){setTimeout(backend.aside.closeUi(),10);backend.message.quick_info(h[e.response_method])}else{show_message(h[e.response_method],1800)}}else{backend.message.quick_info("表單欄位有誤")}clearTimeout(timeout_lock_saving);timeout_lock_saving=setTimeout(function(){is_saving=false},3000)});$(".submit_and_exit").click(function(){save_with_exit=true;save_form()})}catch(c){}$(".file_picker_div input").on("change",function(){var e=$(this).val();$(this).parents(".file_picker_div").find(".file_picker_item").css("background-image","url("+e+")");if($(this).attr("id")=="avatar"){backend.set_avatar(location.href,e)}});$(".filepicker").click(function(){start_filepicker($(this).parents(".file_picker_div").find("input"))});tinyMCE.editors=[];$(".field-type-rich-text-field").each(function(){var e=$(this).prev().text();$(this).prev().remove();var f=$(this).attr("id");if(f==undefined){f=$(this).attr("name");$(this).attr("id",f)}if(f){create_editor(f)}});window.onbeforeunload=function(){$(document).unbind();$(document).find("*").unbind()};setTimeout(function(){$(".fbtn-container").fadeIn()},1000)});function checkNavItemAndShow(){$("a.btn-lang").first().click();$(".list-operations").each(function(){if($(this).find("li").length>0){$(this).removeClass("hide")}else{$(this).addClass("hide")}});if($(".nav-box li").length>0){$(".nav-box").removeClass("hide").addClass("animated").addClass("fadeInUp")}}function linkClickProcess(){$("body").on("click","a",function(e){var _url=$(this).attr("href");if(_url===undefined){e.preventDefault();return}if($(this).hasClass("btn-lang")){e.preventDefault();var lang=$(this).data("lang");$("div.lang").hide();$("div.lang.lang-"+lang).show();return}if($(this).hasClass("btn-json-delete")){e.preventDefault();e.stopPropagation();backend.swal({title:"您確定要刪除此記錄嗎",text:"删除後后将無法恢複，請谨慎操作！",type:"warning",showCancelButton:true,confirmButtonColor:"#DD6B55",confirmButtonText:"删除",cancelButtonText:"取消",showLoaderOnConfirm:true,closeOnConfirm:false},function(){json(_url,null,function(data){swal("删除成功！","您已经永久删除了此記錄。","success");location.reload()},function(data){swal("删除失敗！","刪除記錄時發生問題。","error")})});return}if($(this).hasClass("btn-json")){e.preventDefault();var callback=$(this).data("callback");json(_url,null,function(data){if(callback!==undefined){eval(callback+"("+JSON.stringify(data)+")")}else{location.reload()}},function(data){if(data.code=="404"){show_message("找不到目標頁面")}else{show_message(data.error)}});return}if(_url.indexOf("javascript:")<0&&_url.indexOf("#")<0){var i_text=$(this).find(".icon").text()?($(this).find(".icon").length>0):"";var t=$(this).text().replace(i_text,"").trim();if($(this).attr("target")!="aside_iframe"){backend.iframe.load($(this).attr("href"),t,location.pathname)}else{backend.aside.load($(this).attr("href"))}}})}function makeSortTable(){try{$(".sortable-list tbody").sortable({placeholder:"ui-state-highlight",handle:"td.move-headline",opacity:0.8,cursor:"move",axis:"y",update:function(){var c="";var b=$(".sortable-list tbody");b.find("tr").each(function(){if($(this).data("id")!=undefined){c+="rec[]="+$(this).data("id")+"&"}});json_async("/admin/record/sort.json",c+b.sortable("serialize"),function(d){backend.message.quick_info("排序完成...")},function(d){return false})}})}catch(a){}}function makeListOp(){if($(".filed-display-operations ul").data("done")==true){return false}$("input[data-field]").each(function(){var c=$(this).data("field");var b=$(this).text();var d=$(this).val();var a="checked"?$(this).attr("checked"):"";if(c!="is_enable"&&c!="record_buttons"&&c!=""){$(".filed-display-operations ul").append('<li><input type="checkbox" '+a+' id="ro-field-'+c+'" value="'+d+'"><label for="ro-field-'+c+'">'+$(this).parent().text()+"</label></li>")}});$(".filed-display-operations ul input[type=checkbox]").change(function(){var b=$(this).attr("id").replace("ro-field-","");var a=$(this).is(":checked");$("input[data-field='"+b+"']").click()});$(".filed-display-operations ul").attr("data-done",true)};