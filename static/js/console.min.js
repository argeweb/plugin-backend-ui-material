function json(d,e,b,c){$.ajax({url:d,type:"POST",dataType:"json",data:e,async:!1,success:function(f){b(f)},error:function(f,h,g){void 0==c?show_message(g.message):c(g.message)}})}function json_async(d,e,b,c){$.ajax({url:d,type:"POST",cache:false,dataType:"json",data:e,async:1,success:function(f){b(f)},error:function(f,h,g){void 0==c?show_message(g.message):c(g.message)}})}function replaceParam(g,f,o){g=g.replace("#/","");var n="";var e=g.substring(0,g.indexOf("?"));var l=g.substring(g.indexOf("?"),g.length);var h=0;if(g.indexOf("?")>=0){var k=l.indexOf(f+"=");if(k>=0){h=l.indexOf("&",k);if(h>=0){n=l.substring(k+f.length+1,h);l=g.replace(f+"="+n,f+"="+o)}else{n=l.substring(k+f.length+1,l.length);l=g.replace(f+"="+n,f+"="+o)}}else{l=g+"&"+f+"="+o}}else{l=g+"?"+f+"="+o}return l}function getRandID(d){if(d==undefined){d="rand-id-"}var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var e=0;e<5;e++){d+=c.charAt(Math.floor(Math.random()*c.length))}return d}var aside={instance:null,is_open:false,last_url:null,init:function(b){this.instance=$(b).get(0);$(window).resize(function(){$("#aside_iframe.open").stop().animate({width:($(window).width()<992)?"100%":"52%"},200)})},load:function(b){this.last_url=b;b=replaceParam(b,"aside","true");var c=null;try{c=$(this.instance).contents()}catch(d){c=this.instance.contents()}c.find(".aside-header").stop().animate({top:-70});if(this.is_open){c.find("header").stop().animate({top:-70},250,function(){c.find("body").addClass("body-hide").html('<div id="onLoad"><div class="sk-spinner sk-spinner-chasing-dots"><div class="sk-dot1"></div><div class="sk-dot2"></div></div></div>')})}else{c.find("body").addClass("body-hide").html('<div id="onLoad"><div class="sk-spinner sk-spinner-chasing-dots"><div class="sk-dot1"></div><div class="sk-dot2"></div></div></div>');this.showUi()}$("nav").click();$(this.instance).attr("src",b)},showUi:function(b){$("#aside_iframe").stop().animate({width:($(window).width()<992)?"100%":"52%"},500,function(){aside.is_open=true;if(typeof b==="function"){b()}$(this).addClass("open")})},closeUi:function(b){$("#aside_iframe").stop().animate({width:"0"},500,function(){aside.is_open=false;if(typeof b==="function"){b()}$(this).removeClass("open")})}};var iframe={instance:null,history:{},need_focus:false,init:function(d){this.instance=$(d).get(0);$(d).on("load",function(){var b=iframe.getUrl();var h=iframe.getState(b);if(h){history.replaceState(h,h.text,"#"+h.href)}iframe.instance.contentWindow.showBackToListButton()});window.onpopstate=this.popState;window.reload_iframe=function(){iframe.reload()};window.print_iframe=function(){iframe.print()};window.close_msg_nav=function(){$("header").click()};this.history=JSON.parse(localStorage.getItem("iframe.history"));if(this.history==null||this.history=="null"){this.history=[]}var g=[];var l=$("#menu_usually");l.parent().addClass("hidden");$.map(iframe.history,function(b){if(b.visit>10){g.push(b)}});g.sort(function(n,h){return n.visit<h.visit});var j=0;$.map(g,function(b){if(j<5){j++;l.append('<li><a class="waves-attach" href="'+b.href+'" target="content_iframe">'+b.text+"</a></li>");l.parent().removeClass("hidden")}});var k=$("a[target=content_iframe]");k.click(function(n){var b=$(this).find(".icon").text()?($(this).find(".icon").length>0):"";var h=$(this).text().replace(b,"").trim();iframe.load($(this).attr("href"),h);n.preventDefault()});var m="admin";if(window.location.pathname.indexOf("dashboard")>=0){m="dashboard"}if(window.location.hash){var c=false;var e=window.location.hash.replace("#","");k.each(function(){if($(this).attr("href")==e){c=true;$(this).click()}});if(c==false){var i=this.getState(e);if(i!=null){iframe.load(e,i.text,i.referer_page)}else{var f=e.split("/").slice(0,3).join("/");k.each(function(){if($(this).attr("href")==f){c=true;$(this).click()}})}}if(c==false){iframe.load("/"+m+"/welcome","Welcome")}}else{iframe.load("/"+m+"/welcome","Welcome")}$(".content").hover(function(){},function(){setTimeout(function(){if(iframe.need_focus==false){$(".iframe_mask").show()}},800)});$(".iframe_mask").hover(iframe.focus,function(){iframe.need_focus=false}).mouseover(iframe.focus).mouseenter(iframe.focus).click(iframe.focus)},backToList:function(){var b=iframe.getState(location.hash.replace("#",""));iframe.load(b.referer_page)},print:function(){this.instance.contentWindow.print()},focus:function(){$(".iframe_mask").hide();iframe.need_focus=true;iframe.instance.contentWindow.focus();var b=null;try{b=$(this.instance).contents()}catch(c){b=this.instance.contents()}b.find("body").click()},removeMask:function(){iframe.need_focus=true;$(".iframe_mask").hide()},reload:function(){aside.closeUi();this.instance.contentWindow.location.reload()},saveForm:function(b){if(b){this.instance.contentWindow.save_and_exit()}else{this.instance.contentWindow.save_form()}},changeLang:function(b){this.instance.contentWindow.change_lang(b)},getUrl:function(){return this.instance.contentWindow.location.pathname},load:function(b,g,f){this.pushState(b,g,f);var c=null;try{c=$(this.instance).contents()}catch(d){c=this.instance.contents()}c.find("header").stop().animate({top:-70},250,function(){affix(0);c.find("body").addClass("body-hide").html('<div id="onLoad"><div class="sk-spinner sk-spinner-chasing-dots"><div class="sk-dot1"></div><div class="sk-dot2"></div></div></div>')});$("nav").click();this.focus();$(this.instance).attr("src",b)},getState:function(b){if(b in this.history){return iframe.history[b]}return null},pushState:function(c,f,e){var d=this.getState(e);if(d&&d.referer_page){e=d.referer_page}var b=null;if(c in this.history){b=iframe.history[c];b.last_date=Date.now();if(b.visit){b.visit++}else{b.visit=1}localStorage.setItem("iframe.history",JSON.stringify(this.history));return false}this.history[c]={href:c,text:f,visit:1,last_date:Date.now(),referer_page:e};localStorage.setItem("iframe.history",JSON.stringify(this.history))},popState:function(c){var b=c.state;if(b){iframe.load(b.href,b.text,b.is_list);window.history.replaceState(b,b.text,"#"+b.href)}}};var message={list:[],quick_show:function(c,b){if(b!==undefined){swal({title:c,html:c,timer:b,showConfirmButton:false}).done()}else{swal(c)}},quick_info:function(c,b){$("body").snackbar({alive:b,content:c,show:function(){snackbarText++}})},showInIframe:function(d,b){var c=get_current_tab();console.log(c);c.iframe.get(0).contentWindow.show_message(d,b)},showAll:function(b){$(b).find(".alert").each(function(){var c="info";var d=$(this);if(d.hasClass("alert-info")){c="info"}if(d.hasClass("alert-warning")){c="warning"}if(d.hasClass("alert-success")){c="success"}if(d.hasClass("alert-danger")){c="danger"}message.insert(c,d.data("title"),d.html(),d.data("image"))})},ui:{show:function(b){$(".alert-moment").each(function(){var c=$(this).data("create");$(this).text(moment(c).fromNow())});if($(".msg").length>25){$(".msg").last().remove()}if(b!=undefined&&b==true){clearTimeout(message.ui.hideTimer);message.ui.hideTimerCount=5;message.ui.hideAuto()}},hideAuto:function(){message.ui.hideTimerCount=parseInt(message.ui.hideTimerCount)-1;if(message.ui.hideTimerCount<=0){message.ui.hide()}else{message.ui.hideTimer=setTimeout(message.ui.hideAuto,1000)}},hide:function(){$("#message-box").parent("li").removeClass("open");message.ui.hideTimerCount=0}},insert:function(d,g,f,e,c){var b=getRandID("message-");if(f!=undefined&&f!=""){message.list.push({kind:d,title:g,text:f,image:e,message_id:b,mini:c})}return b},change:function(g,c,f,e,d,b){message.list.push({kind:c,title:f,text:e,image:d,message_id:g,mini:b})},afterInsert:function(){if(message.list.length>0){var g=message.list.pop();if(g!=undefined&&g.text!=""){var h="";var b="";var f="";switch(g.kind){case"info":b='<i class="glyphicon glyphicon-bullhorn"></i>';h="訊息";break;case"warning":b='<i class="glyphicon glyphicon-bell"></i>';h="注意";break;case"danger":b='<i class="glyphicon glyphicon-info-sign"></i>';h="錯誤";break;case"success":b='<i class="glyphicon glyphicon-ok"></i>';h="成功";break}if(g.image!=undefined&&g.image!=""){b='<i class="glyphicon"></i>';f="url("+g.image+")"}else{f="none"}if(g.title!=undefined&&g.title!=""){h=g.title}var d="#"+g.message_id;if($(d).length==0){var c='<li class="msg" id="'+g.message_id+'"><div class="alert"><div class="alert-tag" style="background-size: cover;"></div><span class="alert-moment"></span><span class="alert-title"></span><span class="alert-text"></span></div></li>';$("#message-box").prepend(c)}$(d).find(".alert-tag").html(b).removeClass("alert-info alert-warning alert-danger alert-success").addClass("alert-"+g.kind).css("background-image",f);$(d).find(".alert-moment").data("create",moment().format());$(d).find(".alert-title").text(h);$(d).find(".alert-text").html(g.text);$("#message-count").text($("#message-box li").length-1);var e=false;if(g.mini!=undefined&&g.mini==true){e=g.mini}if(e==false){message.ui.show(true)}}}}};var uploader={init:function(){$(document).on("change","#image-file-picker",function(){uploader.startUpload()})},pickup_target:null,pickup_target_is_editor:false,pickup:function(b,c){uploader.pickup_target=b;uploader.pickup_target_is_editor=c;$("#image-file-picker").click()},startUpload:function(){var c=document.getElementById("image-file-picker");var b=c.files[0];uploader.addFile(b,uploader.pickup_target,function(e){var d=e.response.url;if(uploader.pickup_target_is_editor){uploader.pickup_target.selection.setContent('<img src="'+d+'" />')}else{uploader.pickup_target.val(d).change()}})},addFile:function(c,b,e){var d=message.insert("info","準備上傳","等待中....",undefined,true);json_async("/admin/web_file/get.json",null,function(f){uploader.upload({message_id:d,upload_url:f.url,file:c,target_id:b,callback:e})},function(f){message.change(d,"danger","發生錯誤","無法取得上傳的路徑，請稍候再試一次")})},upload:function(upload_target){var reader=new FileReader();reader.reader_info=upload_target;reader.readAsDataURL(upload_target.file);reader.onload=function(e){this.reader_info.image=this.result;message.change(this.reader_info.message_id,"info","正在上傳","等待中....",this.reader_info.image,true);var fd=new FormData();var xhr=new XMLHttpRequest();xhr.xhr_info=this.reader_info;xhr.upload.upload_info=this.reader_info;xhr.open("POST",this.reader_info.upload_url);xhr.onload=function(data){message.quick_info("上傳完成");message.change(this.xhr_info.message_id,"success","上傳完成","100 %, 上傳完成",this.xhr_info.image,true);if(typeof this.xhr_info.callback==="function"){eval("var a = "+data.currentTarget.response);this.xhr_info.callback({response:a,target_id:this.xhr_info.target_id})}};xhr.onerror=function(e){message.change(this.xhr_info.message_id,"danger","上傳失敗","請重整頁面後再試一次",this.xhr_info.image,true)};xhr.upload.onprogress=function(evt){if(evt.lengthComputable){var complete=(evt.loaded/evt.total*100|0);if(100==complete){complete=99.9}message.change(this.upload_info.message_id,"info","正在上傳",complete+" %",this.upload_info.image,true)}};fd.append("file_name",this.reader_info.file.name);fd.append("file_type",this.reader_info.file.type);fd.append("file",this.reader_info.file);xhr.send(fd)};if(/image\/\w+/.test(upload_target.file.type)){}}};$(function(){iframe.init("#content_iframe");aside.init("#aside_iframe");uploader.init();$(document).bind("keydown",function(b){short_key(window.name,b)});$(".scrollDiv").hover(function(){$(this).addClass("on");iframe.need_focus=false},function(){$(this).removeClass("on")}).mouseover(function(){$(this).addClass("on")}).mouseover(function(){$(this).addClass("on")}).mouseleave(function(){$(this).removeClass("on")})});function affix(b){if(b>0){$("header").addClass("affix")}else{$("header").removeClass("affix").addClass("affix-top")}}function short_key(c,g){var f=iframe.instance.contentWindow;var d=null;if(c=="aside_iframe"){f=aside.instance.contentWindow}if(aside.is_open){d=aside.instance.contentWindow}console.log(c,g.which);;var b=[];var h="";if(g.ctrlKey){b.push(g.key)}if(g.shiftKey){b.push(g.key)}if((g.which>=49)&&(g.which<=57)){b.push(g.which-49)}if(g.ctrlKey){b.push("ctrl")}if(g.ctrlKey&&g.which==80){g.preventDefault();f.print();return false}if(g.ctrlKey&&g.which==37){g.preventDefault();f.print();return false}if(g.ctrlKey&&g.which==39){g.preventDefault();f.print();return false}if(g.ctrlKey&&g.which==116||(g.which||g.keyCode)==116){g.preventDefault();f.reload();return false}if(d&&g.ctrlKey&&g.shiftKey&&(g.which==83)){g.preventDefault();d.save_and_exit();return false}if(d&&g.ctrlKey&&(g.which==83)){g.preventDefault();d.save_form();return false}if(d&&g.altKey&&(g.which>=49)&&(g.which<=57)){g.preventDefault();d.change_lang(g.which-49);return false}};